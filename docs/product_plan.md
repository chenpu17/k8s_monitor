# k8s 监控控制台产品方案

## 1. 背景与目标
- **目标**：打造一个基于 kubelet 数据源的只读 CLI 控制台，实时呈现 Kubernetes 集群的资源与任务运行状况，帮助运维/工程团队快速定位负载热点与潜在风险。
- **现状问题**：现有监控手段分散在多个工具（kubectl、Grafana、日志系统），需要频繁切换；纯图形化方案在 SSH-only 环境中不便使用。
- **定位**：轻量级、可快速部署到任何具备 kubectl/kubelet 接口访问权限的环境；提供关键指标的"一屏式"概览和节点/任务维度钻取。
- **核心价值主张**：
  - **快速上手**：2 周 MVP 验证核心价值，快速迭代响应用户反馈。
  - **环境适应性强**：自动检测数据源可用性并降级，保证在受限环境中仍可用。
  - **主动诊断**：不仅展示数据，还提供"快速诊断模式"主动发现问题并给出建议。
  - **操作友好**：分级错误提示 + 可视化过滤条件 + 命令模式，减少学习成本。

## 2. 用户画像与使用场景
- **集群运维工程师（主用户）**
  - 在集群出现异常告警时，通过 CLI 控制台快速检查节点资源余量、Pod 状态、事件日志。
  - 深夜值班远程 SSH 连接时，以最低依赖快速掌握集群健康。
- **平台开发工程师（次用户）**
  - 验证新部署的服务是否如期运行、资源分配是否匹配预期。
  - 结合自动化脚本定期导出状态快照用于报表。
- **典型使用场景**
  - 集群资源巡检（每日/每周例行）。
  - 故障应急：Pod CrashLoop、节点资源耗尽、网络异常。
  - 部署验收：确认新任务与依赖服务都在运行。

## 3. 关键功能需求
### 3.1 控制台结构
1. **全局概览页（默认视图）**
   - 集群健康摘要：节点在线数/总数、Ready 状态统计、不可调度节点。
   - 核心资源指标：CPU、内存、容器存储使用率（基于可用数据源的实时数据）。
   - 当前告警/事件数量（按严重程度聚合）。
   - Top 5 高负载节点（CPU/内存使用率排序）。
   - Top 5 异常 Pods（按重启次数、状态异常排序）。
   - 最新 5 条 Warning/Error 事件（时间、对象、描述摘要）。
2. **节点视图**
   - 列表：节点名、角色、资源使用（CPU/内存/存储/网络）、Pods 使用率。
   - 钻取详情：容器运行状态、Top N Pods 资源消耗、磁盘 inode/容量占比、节点条件（MemoryPressure 等）。
   - 支持按资源使用率、Pods 数量排序。
3. **工作负载视图**
   - Deployment/StatefulSet/DaemonSet 概览：副本数、就绪数、镜像版本、最近变更。
   - Pod 列表：状态、所在节点、重启次数、资源请求&限制 vs 实际使用、容器状态摘要。
   - 高亮异常状态：CrashLoopBackOff、ImagePullBackOff、Evicted、Pending。
4. **快速诊断模式（v0.2+）**
   - 按 `[D]` 键触发自动诊断：
     - 检测最近 5 分钟 Warning/Error 事件。
     - 识别 CrashLoopBackOff、ImagePullBackOff、Evicted Pods。
     - 扫描节点 NotReady、MemoryPressure、DiskPressure。
     - 生成"风险清单"并高亮显示，提供建议操作。
5. **网络与服务视图（v0.3+）**
   - 节点/Pod 收发流量、网络错误率。
   - Service / Endpoint 状态（可达性、Endpoint 数量、外部 IP/端口）。
   - CNI 组件健康（若可获取）。
6. **事件与告警时间线（v0.2+）**
   - 最近 N 条事件（支持严重度筛选）。
   - 告警来源、对象、描述、持续时间。
7. **历史快照（v0.3+）**
   - 支持手动触发快照保存至本地 JSON 文件，包含：集群信息、节点数据、Top 100 Pods、最近 50 条事件。
   - 提供 `k8s-monitor diff <snapshot1> <snapshot2>` 命令对比差异。
   - 支持导出为 Markdown 报告（便于团队共享）。

### 3.2 交互与操作
- **CLI 形式呈现**：采用面板式布局，支持键盘快捷键在视图间切换。
- **过滤与搜索**：
  - 按命名空间、标签、节点名等条件过滤列表。
  - 按 `F` 键打开过滤面板，输入条件（命名空间、标签选择器），应用后刷新所有视图。
  - 状态栏实时显示当前过滤条件（例如 `[Filter: ns=prod, label=app=web] [Sort: CPU↓]`）。
- **命令模式（v0.2+）**：
  - 按 `:` 键进入命令模式（类似 Vim）：
    - `:filter ns=prod,label=app=web` - 应用过滤条件
    - `:sort cpu desc` - 按 CPU 降序排序
    - `:export /tmp/snapshot.json` - 导出快照
- **刷新机制**：
  - 支持自动刷新（默认 10s，可配置），并提供手动刷新快捷键 `[R]`。
  - 部分数据源返回慢时，允许部分视图先渲染（避免整体阻塞）。
- **只读原则**：
  - 仅提供只读信息，不暴露任何修改集群状态的指令（v0.1-v0.2）。
  - 未来版本可考虑增加"审计模式"（记录所有操作），支持重启 Pod、查看日志等高频运维操作。

### 3.3 数据来源与适配
**数据源优先级策略**：
1. **优先级 1（必需）：Kubernetes API Server**
   - 提供：Pod 状态、事件、节点条件、Deployment/StatefulSet/DaemonSet 等。
   - 访问：通过本机 kubeconfig。
   - 降级处理：若不可用则工具无法启动，提示检查 kubeconfig 配置。

2. **优先级 2（高价值）：kubelet Summary API**
   - 提供：容器级 CPU/内存/磁盘/网络实时数据。
   - 访问方式：
     - 优先：直接访问节点 10250 端口（`https://<node-ip>:10250/stats/summary`）。
     - 降级：通过 API Server 代理访问（`/api/v1/nodes/<node>/proxy/stats/summary`）。
   - 权限要求：需要集群 RBAC 授权访问 `nodes/proxy` 或 `nodes/stats` 资源。
   - 降级处理：若不可用，在界面显示降级提示（见下文"错误恢复与降级"）。

3. **优先级 3（可选）：Metrics Server**
   - 提供：聚合的节点/Pod 指标（如果 kubelet 可用，则此项可降级）。
   - 访问：通过 API Server 的 `/apis/metrics.k8s.io/v1beta1/` 端点。
   - 降级处理：若不可用，优先使用 kubelet Summary API 数据，在界面提示"基于 kubelet 数据，可能滞后 30-60s"。

**受限环境适配**：
- 在只能通过 API Server 代理访问 kubelet 的环境中，自动检测并切换访问方式。
- 若网络策略禁止直接访问节点，工具仍可正常工作（依赖 API Server 代理）。
- 提供缓存机制，访问失败时展示上次成功时间，并在状态栏显示降级状态。

## 4. 非功能需求
- **安全性**：
  - 只读访问；遵循集群 RBAC，尊重 kubeconfig 权限。
  - 敏感信息脱敏：
    - Secret 名称显示，但值显示为 `***`。
    - 环境变量中包含 `PASSWORD`、`TOKEN`、`KEY`、`SECRET` 的自动脱敏。
  - 日志不落地敏感信息。
  - 提供 `--audit-log` 参数，记录所有 API 请求到本地文件（便于安全审计）。
- **性能**
  - 目标规模：中等规模集群（≤100 节点，≤3k Pods）。
  - 单次刷新应在 2s 内完成。
  - 数据拉取并发控制，避免对集群 API 造成额外压力。
  - 超大集群支持（v0.3+）：
    - 200+ 节点场景下，提供分页/懒加载策略。
    - 支持按节点分批拉取 kubelet 数据（避免一次性请求所有节点）。
- **可用性**
  - 支持彩色/非彩色终端；在无需颜色时能读懂信息。
  - 支持终端宽度自适应（80 列起）；超宽时提供更多列。
- **可扩展性**：模块化数据源与面板定义，方便后续新增 GPU、存储卷等专题视图。

## 5. 信息架构与界面布局
- **导航方式**：顶部展示当前视图名称和快捷键提示（例如 `[1] 概览 [2] 节点 [D] 诊断 [R] 刷新 [F] 过滤 [:] 命令`）。
- **面板布局**：
  - 概览页：左侧为资源仪表（CPU/内存/存储），右侧为告警/事件摘要，下方为 Top 5 节点/Pods 列表。
  - 节点页：表格列出节点，选中后在右侧/底部展开详情。
  - 工作负载页：先显示命名空间列表，再进入具体工作负载表格。
- **状态提示**：通过颜色或 icon（如 ✔/⚠/✖）表征健康度，在非彩色终端使用字符替代（OK/WARN/ERR）。
- **过滤流程**：按 `F` 键打开过滤面板，输入条件（命名空间、标签选择器），应用后刷新所有视图，状态栏显示当前过滤条件。

## 6. 数据刷新与进度反馈
- **刷新状态提示**：每次刷新时在状态栏显示"正在获取… / 成功 / 失败"提示及耗时。
- **错误恢复与降级**：若某数据源不可用，提供分级提示和建议操作：
  ```
  ⚠ Metrics Server 不可达（5s 超时）
    → 当前方案：使用 kubelet Summary API 数据（可能滞后 30-60s）
    → 诊断建议：
      1. 检查 Metrics Server 部署：kubectl get pods -n kube-system -l k8s-app=metrics-server
      2. 检查 API 可访问性：kubectl top nodes
      3. 临时禁用 Metrics 面板：按 [S] 键跳过

  ⚠ kubelet Summary API 不可达（节点 node-01，3s 超时）
    → 当前方案：展示上次成功数据（缓存时间：2 分钟前）
    → 诊断建议：
      1. 检查节点状态：kubectl get node node-01
      2. 检查 RBAC 权限：kubectl auth can-i get nodes/proxy
      3. 切换到 Metrics Server 数据：按 [M] 键
  ```
- **并发拉取策略**：
  - 支持在后台按模块并发拉取数据（API Server 基础数据 → kubelet 指标 → Metrics Server 聚合）。
  - 允许部分视图先渲染（例如先显示节点列表，资源指标稍后填充）。
  - 在前端以"模块加载中…"占位，避免整体阻塞。
- **诊断模式**：按 `[D]` 键触发自动诊断，运行常见检查命令（`kubectl get componentstatuses`、`kubectl top nodes`），直接在界面显示诊断结果。

## 7. 部署与集成流程
- 依赖：本地安装 kubectl/kubeconfig；可选 metrics-server 访问权限。
- 运行方式：`k8s-monitor console --kubeconfig <path> [--node <node-name>] [--namespace <ns>]`
- 可作为独立二进制/脚本，也可嵌入现有运维工具集。
- 提供容器化打包方案（可运行在运维 Bastion 主机），容器内以挂载 kubeconfig 的方式访问。

## 8. 里程碑与迭代建议
### v0.1 MVP（2 周，快速验证核心价值）
**目标**：让用户快速用起来，验证"一屏式概览 + 节点钻取"的核心价值。

**功能范围**：
1. **全局概览页**：
   - 集群健康摘要（节点在线数、Ready 状态）。
   - Top 5 高负载节点、Top 5 异常 Pods。
   - 最新 5 条 Warning/Error 事件。
2. **节点视图**：
   - 节点列表（名称、角色、资源使用率、Pods 数量）。
   - 基础钻取（选中节点显示详情：条件、Top Pods）。
3. **交互**：
   - 手动刷新（`[R]` 键）。
   - 基础过滤（按命名空间，`[F]` 键）。
4. **数据源**：
   - Kubernetes API Server（必需）。
   - kubelet Summary API（尝试获取，失败时提示）。
5. **认证与错误处理**：
   - kubeconfig 认证。
   - 基础错误提示（数据源不可用时显示降级信息）。

**交付物**：可运行的二进制文件，支持单集群监控。

---

### v0.2（3 周，增强交互与完善视图）
**目标**：补全核心视图，增强用户体验。

**功能范围**：
1. **工作负载视图**：
   - Deployment/StatefulSet/DaemonSet 列表。
   - Pod 列表（状态、重启次数、资源使用）。
   - 高亮异常状态（CrashLoopBackOff、ImagePullBackOff）。
2. **事件时间线**：
   - 最近 N 条事件（支持严重度筛选）。
3. **快速诊断模式**：
   - 按 `[D]` 键触发自动诊断（检测异常 Pods、节点压力、事件）。
   - 生成风险清单并提供建议操作。
4. **交互增强**：
   - 自动刷新（默认 10s，可配置）。
   - 命令模式（`:filter`、`:sort`、`:export`）。
   - 状态栏显示当前过滤/排序条件。
5. **性能优化**：
   - 数据缓存（避免重复请求）。
   - 并发请求控制（限制并发数，避免 API 压力）。
   - 部分视图先渲染（避免整体阻塞）。

**交付物**：功能完整的监控工具，支持日常巡检和故障应急。

---

### v0.3+（4 周，高级功能与生产环境优化）
**目标**：支持更大规模集群，提供高级分析功能。

**功能范围**：
1. **网络与服务视图**：
   - 节点/Pod 流量统计。
   - Service/Endpoint 状态。
2. **历史快照与对比**：
   - 手动触发快照保存（JSON 格式）。
   - `k8s-monitor diff <snapshot1> <snapshot2>` 对比差异。
   - 导出 Markdown 报告（便于团队共享）。
3. **超大集群支持**：
   - 200+ 节点场景下的分页/懒加载。
   - 按节点分批拉取 kubelet 数据。
4. **安全性增强**：
   - `--audit-log` 参数记录所有 API 请求。
   - 敏感信息脱敏（Secret、环境变量）。
5. **可扩展性**：
   - 自定义仪表（用户可定义面板与指标组合）。
   - 与外部告警系统对接（只读订阅，如 Alertmanager）。

**交付物**：生产级监控工具，支持企业级集群。

## 9. 近期范围澄清与设计决策
以下是关键设计决策及其理由：

### 9.1 明确支持的场景
| 问题 | 决策 | 理由 |
|------|------|------|
| 多集群支持？ | **v0.1-v0.2 仅支持单集群**；v0.3+ 可考虑集群切换器 | 避免 MVP 复杂度过高，先验证单集群价值 |
| 数据源降级方案？ | **支持自动降级**：Metrics Server 不可用时使用 kubelet Summary API；kubelet 不可用时使用缓存数据 | 保证工具在受限环境中仍可用 |
| 终端交互增强（鼠标支持）？ | **v0.1-v0.2 不支持**；v0.3+ 可考虑 tmux/鼠标兼容 | 优先保证键盘操作流畅，避免兼容性问题 |
| 外部告警系统集成？ | **v0.1-v0.2 不集成**；v0.3+ 可考虑只读订阅 Alertmanager | 避免引入外部依赖，先保证独立工作 |
| 只读 vs 写操作？ | **v0.1-v0.2 纯只读**；v0.3+ 可考虑"审计模式"（记录所有操作） | 先验证只读价值，未来按需扩展 |

### 9.2 目标用户规模定位
- **v0.1-v0.2**：中等规模集群（≤100 节点，≤3k Pods）。
- **v0.3+**：支持更大规模（200+ 节点），提供分页/懒加载策略。

### 9.3 数据实时性权衡
- **策略**：允许部分视图先渲染，避免整体阻塞。
- **示例**：
  - 先显示节点列表（来自 API Server，通常 <500ms）。
  - 再填充资源指标（来自 kubelet/Metrics Server，可能 1-2s）。
  - 状态栏显示："加载中：kubelet 数据（3/10 节点已完成）"。

### 9.4 kubelet 访问权限适配
- **优先方案**：直接访问节点 10250 端口（需要网络可达 + 证书）。
- **降级方案**：通过 API Server 代理访问（`/api/v1/nodes/<node>/proxy/stats/summary`）。
- **完全失败**：展示缓存数据 + 降级提示，建议用户检查 RBAC 权限。

### 9.5 错误处理哲学
**核心原则**：不要让用户困惑，提供"当前方案 + 诊断建议 + 快速操作"。

**示例**：
```
✖ API Server 连接失败（context deadline exceeded）
  → 当前状态：工具无法启动
  → 诊断建议：
    1. 检查 kubeconfig 路径：echo $KUBECONFIG
    2. 测试连接：kubectl get nodes
    3. 检查网络：ping <api-server-ip>
  → 快速操作：按 [Q] 退出，按 [R] 重试连接
```

---

## 10. 文档修订历史

### v2.0（2025-01-06）- 根据技术评审优化方案
**主要修改**：
1. **MVP 范围收窄**：
   - v0.1 聚焦"概览 + 节点视图"，工作负载视图移至 v0.2。
   - 明确 2 周交付可运行的 MVP，3 周补全核心功能。

2. **数据源策略优化**：
   - 明确数据源优先级（API Server → kubelet → Metrics Server）。
   - 增加受限环境适配方案（API Server 代理访问 kubelet）。
   - 增加自动降级机制（数据源不可用时切换备选方案）。

3. **错误处理增强**：
   - 设计分级错误提示（当前方案 + 诊断建议 + 快速操作）。
   - 增加"诊断模式"（`[D]` 键触发自动检查）。
   - 明确错误恢复流程（降级、缓存、重试）。

4. **交互体验优化**：
   - 增加命令模式（`:filter`、`:sort`、`:export`）。
   - 状态栏显示当前过滤/排序条件（可视化反馈）。
   - 允许部分视图先渲染（避免整体阻塞）。

5. **安全性补充**：
   - 敏感信息脱敏（Secret、环境变量中的密码/Token）。
   - 增加 `--audit-log` 参数（记录所有 API 请求）。

6. **性能目标细化**：
   - 明确目标规模（v0.1-v0.2 支持 ≤100 节点，v0.3+ 支持 200+ 节点）。
   - 超大集群支持策略（分页、懒加载、分批拉取）。

7. **快照功能增强**（v0.3+）：
   - 定义快照格式（JSON，包含集群信息、节点、Pods、事件）。
   - 增加 `k8s-monitor diff` 命令对比快照差异。
   - 支持导出 Markdown 报告。

8. **快速诊断模式**（v0.2+）：
   - 新增功能：自动检测异常 Pods、节点压力、事件。
   - 生成风险清单并提供建议操作。

### v1.0（初始版本）
- 初始产品方案，包含基础功能定义和迭代计划。
